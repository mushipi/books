# 本管理アプリケーション開発メモ

## Gemini APIを活用した書籍一括取り込み機能の実装（2025-05-03）

### 実装概要

カメラ機能の代替として、書籍裏表紙の画像からISBN/JANコード、Cコード、価格情報を抽出して一括取り込みする機能を実装しました。Google Gemini APIによる高精度な画像認識を活用しています。

### 主要コンポーネント

1. **BookCodeExtractorクラス**
   - 書籍コード抽出の中核機能
   - Gemini APIを活用した高精度認識
   - エラーハンドリング機能の強化

2. **BulkImportServiceクラス**
   - フォルダスキャン機能
   - 重複チェック機能
   - インポート処理の一元管理

3. **BookServiceクラス**
   - 書籍情報の検索・登録処理
   - JANコードによる重複管理
   - データベース操作の抽象化

4. **コントローラとUI**
   - スキャン画面
   - 結果選択画面
   - インポート結果表示

### 追加ファイル

- `services/book_code_extractor.py` - 書籍コード抽出機能
- `services/bulk_import_service.py` - 一括取り込み機能
- `services/book_service.py` - 書籍登録サービス
- `controllers/bulk_import_controller_new.py` - コントローラ
- `templates/bulk_import/*.html` - 画面テンプレート
- `install_gemini_api.bat` - Gemini APIインストールスクリプト
- `start_app_gemini_new.bat` - アプリ起動スクリプト

### 設定変更

- `config.py`にGemini API関連の設定を追加
- `app.py`を更新し、新機能を統合

### 使用方法

1. `install_dependencies_complete.bat`を実行してライブラリを一括インストール
2. `start_app_gemini_new.bat`でアプリを起動
3. ブラウザで`http://localhost:5000`にアクセス
4. メニューから「一括取り込み」を選択
5. フォルダパスとデフォルトジャンルを指定してスキャン
6. 取り込みたい書籍を選択してインポート実行

### 環境構築での注意点（2025-05-03追記）

1. **依存関係の互換性**:
   - SQLAlchemyは1.4.46を使用する必要あり（Flask-SQLAlchemy 2.5.1との互換性のため）
   - NumPy 2.2.5とOpenCV 4.7.0.72には互換性の問題があり、バーコードスキャン機能に影響
   - Gemini API機能は上記の問題に影響されず動作可能

2. **現在の状態**:
   - アプリケーションは正常に起動し、一括取り込み機能は正常に動作
   - バーコードスキャン機能は互換性の問題で無効化されている
   - 必要に応じてNumPyのダウングレード（1.24.3など）で全機能を有効化できる可能性あり

3. **実行環境**:
   - Python 3.12環境で実行
   - 仮想環境(venv)内で依存関係を管理

4. **アクセス方法**:
   - ブラウザで`http://localhost:5000/bulk-import/`にアクセスして一括取り込み機能を利用可能

### バグ修正（2025-05-03追記）

データベース登録時のフィールド名不一致による問題を修正しました。

1. **修正内容**:
   - `BookService`クラス内で使用しているフィールド名を`cover_image`から`cover_image_path`に修正
   - デバッグ情報の出力を強化し、問題箇所を特定しやすく
   - `Book`モデルの`cover_image_path`フィールドを`nullable=True`に設定し、より堅牢に

2. **対応ファイル**:
   - `services/book_service.py`: `register_book_by_jan`、`create_book`、`update_book`メソッドの修正
   - `services/api_service.py`: 表紙画像に関するデバッグログの追加
   - `services/bulk_import_service.py`: エラーハンドリングとデバッグ情報の強化
   - `models/book.py`: カバー画像フィールドの修正

### Jinja2 テンプレートフィルター追加（2025-05-03追記）

本の詳細画面でジャンルを選択して保存する際にエラーが発生する問題を修正しました。

1. **問題**:
   - `jinja2.exceptions.TemplateRuntimeError: 'nl2br' という名前のフィルターが見つかりません`
   - 詳細画面のメモ表示部分で使用されるnl2brフィルターが未定義

2. **修正内容**:
   - `app.py`にMarkupをインポート
   - nl2brテンプレートフィルターを定義（改行を`<br>`タグに変換）

3. **修正ファイル**:
   - `app.py`: nl2brフィルター関数の追加

### 表紙画像取得機能の問題調査（2025-05-03追記）

本の表紙画像の自動取得ロジックに問題が見つかったため、調査を行いました。

1. **現状の問題点**:
   - `api_service.py`の`_save_cover_image`メソッドでの画像保存が正常に機能していない
   - 画像パスの扱いに一貫性がなく、相対パスと絶対パスの混在が見られる
   - エラーハンドリングが不十分で、問題発生時のデバッグが困難

2. **調査結果**:
   - `ApiService`クラスでは画像URLからダウンロードして保存する処理を実装
   - パス処理に問題があり、カバー画像フォルダの絶対パスと相対パスの変換が不明確
   - 例外処理が不十分で、ネットワークエラーや画像処理エラー時の対応が不足

### 表紙画像取得の代替案（2025-05-03追記）

現在の実装に代わる、より堅牢な表紙画像取得方法を検討しました。

#### 代替案1: 複数のAPIソースを利用した冗長化システム

1. **実装概要**:
   - OpenBD API（現行）に加えて、Google Books API、楽天書籍API、国会図書館APIなど複数のソースを活用
   - ISBNをキーに複数APIに並列リクエストし、最初に応答があったものを使用
   - 各APIごとに専用のパーサーとダウンローダーを実装

2. **メリット**:
   - 単一APIへの依存がなくなり可用性が向上
   - 書籍情報の精度向上（複数ソースからのデータ統合）
   - カバー画像の取得成功率向上

3. **実装方針**:
   - `BookCoverProvider`インターフェースを定義
   - 各API用の実装クラスを作成（`OpenBDCoverProvider`, `GoogleBooksCoverProvider`など）
   - ファクトリーパターンで適切なプロバイダーを選択
   - 取得した画像をローカルキャッシュとして保存

#### 代替案2: ローカルキャッシュとオンデマンド取得の組み合わせ

1. **実装概要**:
   - 表紙画像URLを保存するだけで、実際の画像はオンデマンドでフロントエンドが取得
   - 書籍の登録時にはURLのみ保存し、表示時に動的にロード
   - オプションでローカルにキャッシュする機能を提供

2. **メリット**:
   - バックエンド処理が簡素化（画像処理/保存の負担減少）
   - ディスク使用量の削減
   - フロントエンドでの柔軟な画像処理が可能

3. **実装方針**:
   - `Book`モデルに`cover_image_url`フィールドを追加
   - フロントエンドでの画像ロード処理を実装
   - オプションで指定した時のみ画像をダウンロード
   - プロキシ経由で外部画像をロードし、CORS問題を回避

#### 代替案3: 分離されたコンテンツ管理システムの活用

1. **実装概要**:
   - 表紙画像の管理を専用のコンテンツ管理コンポーネントに分離
   - MinIO、AWS S3、または単純なファイルシステムベースのストレージサービスを実装
   - ISBNをキーにした統一的なアクセス方法を提供

2. **メリット**:
   - 画像管理が一元化され、拡張性が向上
   - 将来的なスケールアウトが容易（クラウドストレージ連携など）
   - 本管理ロジックと画像管理の関心事が分離される

3. **実装方針**:
   - `ContentStorageService`クラスを新規作成
   - 保存先を設定ファイルで切り替え可能に
   - 独自のキャッシュ戦略を実装
   - URLやファイルパスの生成を一元管理

### 国立国会図書館APIを利用した表紙画像取得機能の実装（2025-05-04追記）

国立国会図書館が提供する書籍サムネイルAPIを活用して、より堅牢な表紙画像取得システムを実装しました。

#### 実装概要

1. **機能の特徴**:
   - 国立国会図書館のサムネイルAPIを使用して書籍表紙画像を取得
   - OpenBD APIと併用し、片方が失敗した場合は他方でフォールバック
   - ISBNのバリデーションとフォーマット正規化の強化
   - 画像処理と保存プロセスの改善

2. **実装ファイル**:
   - `services/ndl_cover_service.py`: 国会図書館表紙画像取得サービス
   - `services/api_service_enhanced.py`: 改良版APIサービス（複数APIソース対応）
   - `test_enhanced_api.py`: テスト用スクリプト

3. **基本的な処理フロー**:
   - ISBNコードを受け取り、ハイフンを除去して正規化
   - ISBNの形式チェックとチェックディジット検証を実施
   - 国会図書館APIで表紙画像を取得（`https://ndlsearch.ndl.go.jp/thumbnail/{ISBN}.jpg`）
   - 画像データを検証し、必要に応じてリサイズ処理
   - 保存先フォルダに画像を保存し、相対パスを返却

#### 実装詳細

1. **NDLCoverServiceクラス**:
   - 国会図書館APIを使用した表紙画像取得に特化したクラス
   - ISBNの形式検証と正規化機能を内蔵
   - 画像のリサイズと品質調整機能

2. **ApiServiceクラスの強化**:
   - 既存のOpenBD APIと国会図書館APIを併用
   - カスケード方式で複数のソースを順次試行
   - 詳細なロギングによるデバッグ支援
   - エラーハンドリングの強化

3. **テストスクリプト**:
   - 複数のISBNパターンでの動作検証
   - 結果の詳細なロギングと検証
   - エラーケースの処理確認

#### 導入手順

1. 新規ファイルの配置:
   - `services/ndl_cover_service.py`
   - `services/api_service_enhanced.py`
   - `test_enhanced_api.py`

2. 既存APIサービスの置き換え:
   - `services/api_service.py`を`services/api_service_enhanced.py`に置き換える

3. 動作確認:
   - `python test_enhanced_api.py`を実行
   - すべてのテストケースが正常に完了することを確認

4. アプリケーションでの有効化:
   - アプリケーション起動前に依存関係の確認
   - 実行時のログでエラー有無の確認

#### 期待される効果

1. **表紙画像取得率の向上**:
   - 複数のソースを利用することで、単一APIの障害に影響されにくい
   - 国内書籍の場合、国会図書館APIがより高い確率で画像を提供

2. **パフォーマンスと安定性の向上**:
   - より堅牢なエラーハンドリング
   - キャッシュ機構による二重ダウンロードの防止
   - 詳細なロギングによる問題追跡の容易化

3. **拡張性の確保**:
   - 将来的に他のAPIソースも同様の方法で追加可能
   - 実装アーキテクチャがより明確に分離

### 今後の課題

1. **ローカル処理による認識精度の向上**:
   - pyzbarとOpenCVを活用したバーコード認識の改善
   - ローカルOCRの導入検討

2. **処理効率の最適化**:
   - 画像の前処理機能の強化
   - キャッシュ機能の追加

3. **UI/UXの改善**:
   - 処理状況の視覚化
   - エラー時のフィードバック強化

4. **機能拡張**:
   - 付属資料の管理
   - メモの一括登録

5. **環境互換性の強化**:
   - NumPyおよびOpenCVの互換性問題の解決
   - 依存関係を安定させるための厳密なバージョン管理
